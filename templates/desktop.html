{% extends "base.html" %}

{% block title %}Desktop - Pixel Pusher OS{% endblock %}
{% block description %}Pixel Pusher OS Desktop Environment - Access your applications, files, and games in a modern web-based interface.{% endblock %}

{% block body_class %}desktop-environment{% endblock %}

{% block extra_css %}
<style>
    /* Desktop Environment Styles */
    .desktop-environment {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: var(--font-family);
    }

    /* Desktop Container */
    #desktop {
        position: relative;
        width: 100%;
        height: 100vh;
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        user-select: none;
        overflow: hidden;
    }

    /* Desktop Icons */
    .desktop-icon {
        position: absolute;
        width: 80px;
        height: 80px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        text-align: center;
    }

    .desktop-icon:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: scale(1.05);
    }

    .desktop-icon.selected {
        background-color: rgba(0, 217, 255, 0.3);
        transform: scale(1.05);
    }

    .desktop-icon .icon-image {
        font-size: 32px;
        margin-bottom: 4px;
        line-height: 1;
    }

    .desktop-icon .icon-label {
        font-size: 11px;
        color: white;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        word-wrap: break-word;
        line-height: 1.2;
        max-width: 100%;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    /* Window Container */
    #windowContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 100;
    }

    /* Window Styles */
    .window {
        position: fixed;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        pointer-events: auto;
        transition: all 0.2s ease;
        min-width: 300px;
        min-height: 200px;
    }

    .window.active {
        box-shadow: 0 12px 40px rgba(0, 217, 255, 0.2);
        border-color: var(--primary);
    }

    /* Window Header */
    .window-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--surface-light);
        border-bottom: 1px solid var(--border);
        cursor: move;
        user-select: none;
        min-height: 32px;
    }

    .window-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
        flex: 1;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .window-controls {
        display: flex;
        gap: 4px;
    }

    .window-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: opacity 0.2s;
    }

    .window-btn:hover {
        opacity: 0.8;
    }

    .minimize-btn {
        background: var(--warning);
    }

    .maximize-btn {
        background: var(--success);
    }

    .close-btn {
        background: var(--error);
    }

    /* Window Content */
    .window-content {
        flex: 1;
        overflow: auto;
        position: relative;
        background: var(--background);
    }

    /* Taskbar */
    #taskbar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: var(--surface-dark);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 8px;
        z-index: 9999;
        gap: 4px;
        backdrop-filter: blur(10px);
    }

    .taskbar-button {
        padding: 4px 12px;
        border: none;
        border-radius: 4px;
        background: var(--surface);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 12px;
        max-width: 150px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        transition: all 0.2s ease;
    }

    .taskbar-button:hover {
        background: var(--surface-light);
    }

    .taskbar-button.active {
        background: var(--primary);
        color: white;
    }

    .taskbar-button.minimized {
        opacity: 0.6;
    }

    /* System Tray */
    #systemTray {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 12px;
    }

    #systemTime {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    /* Context Menu */
    .context-menu {
        position: fixed;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        min-width: 150px;
        display: none;
    }

    .context-item {
        padding: 8px 16px;
        cursor: pointer;
        color: var(--text-primary);
        font-size: 14px;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .context-item:hover {
        background-color: var(--primary);
        color: white;
    }

    .context-separator {
        height: 1px;
        background-color: var(--border);
        margin: 4px 0;
    }

    /* Terminal Styles */
    .terminal-container {
        font-family: var(--font-mono);
        background: #1a1a1a;
        color: #00ff00;
        padding: 16px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .terminal-output {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 8px;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.4;
        font-size: 14px;
    }

    .terminal-input-line {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        border-top: 1px solid #333;
    }

    .terminal-prompt {
        color: #00d9ff;
        font-weight: bold;
        white-space: nowrap;
    }

    .terminal-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: #00ff00;
        font-family: inherit;
        font-size: 14px;
        caret-color: #00ff00;
    }

    /* Explorer Styles */
    .explorer-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--background);
    }

    .explorer-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--surface-light);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
    }

    .explorer-toolbar button {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--surface);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
    }

    .explorer-toolbar button:hover {
        background: var(--surface-light);
        border-color: var(--primary);
    }

    .explorer-path {
        flex: 1;
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--surface);
        color: var(--text-primary);
        font-size: 13px;
        font-family: var(--font-mono);
    }

    .explorer-content {
        flex: 1;
        overflow: auto;
        padding: 12px;
        background: var(--background);
    }

    /* Game Styles */
    .game-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: #000;
        align-items: center;
        justify-content: center;
    }

    .game-content {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
    }

    /* Settings Styles */
    .settings-container {
        display: flex;
        height: 100%;
        background: var(--background);
    }

    .settings-sidebar {
        width: 200px;
        background: var(--surface-dark);
        border-right: 1px solid var(--border);
        padding: 16px 0;
        flex-shrink: 0;
    }

    .settings-nav-item {
        padding: 12px 20px;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .settings-nav-item:hover {
        background-color: var(--surface-light);
        color: var(--text-primary);
    }

    .settings-nav-item.active {
        background-color: var(--primary);
        color: white;
        border-left-color: var(--primary-light);
    }

    .settings-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: var(--background);
    }

    /* Loading States */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .desktop-icon {
            width: 60px;
            height: 60px;
        }

        .desktop-icon .icon-image {
            font-size: 24px;
        }

        .desktop-icon .icon-label {
            font-size: 10px;
        }

        .window {
            min-width: 280px;
        }

        .settings-sidebar {
            width: 150px;
        }

        .settings-content {
            padding: 16px;
        }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
        .desktop-icon,
        .window,
        .taskbar-button,
        .context-item {
            transition: none;
        }

        .loading-spinner {
            animation: none;
        }
    }

    /* Print Styles */
    @media print {
        #desktop,
        #taskbar,
        .context-menu {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Desktop Environment -->
<div id="desktop">
    <!-- Desktop icons will be dynamically created by JavaScript -->
</div>

<!-- Window Container -->
<div id="windowContainer">
    <!-- Application windows will be dynamically created here -->
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu">
    <div class="context-item" onclick="contextAction('terminal')">
        💻 Open Terminal
    </div>
    <div class="context-item" onclick="contextAction('explorer')">
        📁 Open File Explorer
    </div>
    <div class="context-separator"></div>
    <div class="context-item" onclick="contextAction('newfile')">
        📄 New File
    </div>
    <div class="context-item" onclick="contextAction('newfolder')">
        📂 New Folder
    </div>
    <div class="context-separator"></div>
    <div class="context-item" onclick="contextAction('refresh')">
        🔄 Refresh Desktop
    </div>
</div>

<!-- Taskbar -->
<div id="taskbar">
    <!-- Start button or logo -->
    <div style="margin-right: 8px; font-weight: bold; color: var(--primary);">
        🎨 Pixel Pusher OS
    </div>

    <!-- Taskbar buttons will be dynamically created here -->

    <!-- System tray -->
    <div id="systemTray">
        <div id="systemTime">--:--:--</div>
    </div>
</div>

<!-- Hidden user data for JavaScript -->
<div id="userData" style="display: none;">
    <div data-user="{{ user.username }}" data-group="{{ user.user_group }}"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load all JavaScript modules in correct order -->

<!-- Core utilities first -->
<script src="{{ url_for('static', filename='js/utils/helpers.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils/state.js') }}"></script>

<!-- Core system modules -->
<script src="{{ url_for('static', filename='js/core/auth.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/desktop.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/windows.js') }}"></script>

<!-- Application modules -->
<script src="{{ url_for('static', filename='js/apps/terminal.js') }}"></script>
<script src="{{ url_for('static', filename='js/apps/explorer.js') }}"></script>
<script src="{{ url_for('static', filename='js/apps/games.js') }}"></script>
<script src="{{ url_for('static', filename='js/apps/settings.js') }}"></script>

<!-- Main application controller (loads last) -->
<script src="{{ url_for('static', filename='js/core/app.js') }}"></script>

<!-- Desktop-specific initialization -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🖥️ Desktop environment loading...');

    // Initialize desktop with user preferences
    const userPreferences = {{ preferences | tojson | safe }};
    console.log('👤 User preferences loaded:', userPreferences);

    // Apply saved theme
    if (userPreferences.theme) {
        window.PixelPusherTheme.set(userPreferences.theme);
    }

    // Apply saved wallpaper
    if (userPreferences.wallpaper) {
        const desktop = document.getElementById('desktop');
        if (desktop) {
            desktop.style.backgroundImage = `url(${userPreferences.wallpaper})`;
        }
    }

    // Set font size
    if (userPreferences.fontSize) {
        document.documentElement.style.fontSize = userPreferences.fontSize + 'px';
    }

    // Disable animations if requested
    if (userPreferences.animations === false) {
        document.body.classList.add('no-animations');
    }

    console.log('✅ Desktop environment ready');

    // Show welcome message for new users
    {% if user.login_count == 1 %}
    setTimeout(function() {
        if (window.pixelPusher && window.pixelPusher.showModal) {
            const welcomeContent = `
                <div style="text-align: center;">
                    <h2>🎉 Welcome to Pixel Pusher OS!</h2>
                    <p>Welcome, <strong>{{ user.username }}</strong>! Your desktop environment is ready.</p>
                    <div style="margin: 20px 0; text-align: left;">
                        <strong>Quick Tips:</strong><br>
                        • Double-click icons to open applications<br>
                        • Right-click desktop for context menu<br>
                        • Use keyboard shortcuts for quick access<br>
                        • Customize your experience in Settings
                    </div>
                    <div style="margin: 20px 0;">
                        <strong>Keyboard Shortcuts:</strong><br>
                        <kbd>Ctrl+Alt+T</kbd> Terminal |
                        <kbd>Ctrl+Alt+E</kbd> Explorer |
                        <kbd>Ctrl+Alt+S</kbd> Settings
                    </div>
                    <button onclick="this.closest('.modal').remove()" class="btn btn-primary">
                        Let's Get Started! 🚀
                    </button>
                </div>
            `;
            window.pixelPusher.showModal('Welcome to Pixel Pusher OS', welcomeContent);
        }
    }, 2000);
    {% endif %}
});

// Global helper functions for backward compatibility
function openWindow(windowId) {
    if (window.pixelPusher) {
        window.pixelPusher.openApplication(windowId);
    }
}

function closeWindow(windowId) {
    if (window.pixelPusher) {
        window.pixelPusher.closeApplication(windowId);
    }
}

function contextAction(action) {
    if (window.pixelPusher) {
        switch(action) {
            case 'terminal':
            case 'explorer':
                window.pixelPusher.openApplication(action);
                break;
            case 'newfile':
                window.PixelPusherUtils.showNotification('Creating new file...', 'info');
                break;
            case 'newfolder':
                window.PixelPusherUtils.showNotification('Creating new folder...', 'info');
                break;
            case 'refresh':
                window.location.reload();
                break;
            default:
                console.log('Context action:', action);
        }
        window.pixelPusher.closeAllContextMenus();
    }
}

// Performance monitoring
console.log('📊 Performance Info:');
console.log('Load Time:', Math.round(performance.now()), 'ms');
console.log('User Agent:', navigator.userAgent);
console.log('Screen:', screen.width + 'x' + screen.height);
console.log('Viewport:', window.innerWidth + 'x' + window.innerHeight);

// Browser compatibility checks
const features = {
    'Fetch API': 'fetch' in window,
    'Local Storage': 'localStorage' in window,
    'WebGL': (() => {
        try {
            const canvas = document.createElement('canvas');
            return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
        } catch {
            return false;
        }
    })(),
    'Web Workers': 'Worker' in window,
    'Service Workers': 'serviceWorker' in navigator
};

console.log('🔧 Browser Features:', features);

// Warn about unsupported features
Object.entries(features).forEach(([feature, supported]) => {
    if (!supported) {
        console.warn(`⚠️ ${feature} not supported - some features may not work`);
    }
});
</script>
{% endblock %}